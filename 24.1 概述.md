24章 虚拟机扩展介绍

## 24.1 概述

本章介绍了虚拟机架构的基础架构和支持处理器硬件在多个软件环境中进行虚拟化的虚拟机扩展（VMX）的概述。 有关 VMX 指令的信息可以在《英特尔® 64 位和 IA-32 架构软件开发手册》第2B卷中找到。关于 VMX 的其他方面和系统编程注意事项在《英特尔® 64 位和 IA-32 架构软件开发手册》第3C卷的各个章节中进行了描述。

## 24.2 虚拟机架构

虚拟机扩展定义了在 IA-32 处理器上对虚拟机的处理器级别支持。它支持两个主要类别的软件

- 虚拟机监视器（VMM）- VMM 作为host，并对处理器和其他平台硬件具有完全控制权。VMM 为Guest software（见下一段）提供虚拟处理器的抽象，并允许其直接在逻辑处理器上执行。VMM 能够保留对处理器资源、物理内存、中断管理和输入/输出的选择性控制。
- Guest software - 每个虚拟机（VM）是一个Guest software环境，支持由操作系统（OS）和应用软件组成的堆栈。每个虚拟机都独立于其他虚拟机运行，并使用相同的接口访问处理器、内存、存储、图形和物理平台提供的输入/输出。软件堆栈的运行方式就像在没有 VMM 的平台上运行一样。在虚拟机中执行的软件必须以降低的权限运行，以便 VMM 可以保留对平台资源的控制。

## 24.3 VMX操作介绍

处理器对虚拟化的支持是通过一种称为 VMX 操作的处理器操作形式提供的。VMX 操作包括两种类型：VMX 根操作和 VMX 非根操作。一般情况下，VMM 将在 VMX 根操作中运行，而客户软件将在 VMX 非根操作中运行。在 VMX 根操作和 VMX 非根操作之间的切换称为 VMX 转换。VMX 转换分为两种类型。进入 VMX 非根操作的转换称为 VM 进入（VM entries），从 VMX 非根操作到 VMX 根操作的转换称为 VM 退出（VM exits）。

在 VMX 根操作中，处理器的行为与在 VMX 操作十分相似。主要的区别是有一组新指令（VMX 指令）可用，并且可以加载到某些控制寄存器的值是受到限制的（参见第24.8节）。

在 VMX 非根操作中，处理器的行为受到限制和修改，以便实现虚拟化。某些指令（包括新的 VMCALL 指令）和事件不再按照普通的方式运行，而是导致 VM 退出到 VMM。由于VM 退出取代了普通的行为，因此在 VMX 非根操作中的软件功能受到限制。正是这种限制使得 VMM 能够保持对处理器资源的控制。

在 VMX 非根操作中，没有可见的位来指示逻辑处理器是否处于 VMX 非根操作。这个事实可以使得 VMM 防止客户软件确定其运行在虚拟机中。

由于 VMX 操作甚至对以当前特权级（CPL）0运行的软件也施加了限制，因此客户软件可以以其最初设计的特权级运行。这种将简化 VMM 的开发过程。

## 24.4 VMM的生命周期

略过，请参照原文

## 24.5 虚拟机控制结构

VMX非根操作和VMX转换受到称为虚拟机控制结构（VMCS）的数据结构的控制。

对VMCS的访问,通过处理器状态的一个组成部分，即VMCS指针（每个逻辑处理器一个）管理。VMCS指针的值是VMCS的64位地址。使用VMPTRST和VMPTRLD指令读取和写入VMCS指针。VMM使用VMREAD、VMWRITE和VMCLEAR指令配置VMCS。

VMM可以为其支持的每个虚拟机使用不同的VMCS。对于具有多个逻辑处理器（虚拟处理器）的虚拟机，VMM可以为每个虚拟处理器使用不同的VMCS。

## 24.6 DISCOVERING SUPPORT FOR VMX（不知道怎么翻）

在系统软件进入VMX操作之前，它必须发现处理器是否支持VMX操作。系统软件可以使用CPUID来确定处理器是否支持VMX操作。如果CPUID.1:ECX.VMX[bit 5] = 1，则表示支持VMX操作。可以参考英特尔® 64和IA-32体系结构软件开发手册第2A卷的第3章“指令集参考”来了解更多信息。

VMX架构被设计为可扩展的，这样在VMX操作中的未来处理器可以支持第一代VMX架构中不存在的其他功能。可扩展的VMX功能的可用性通过一组VMX能力MSR向软件报告（请参阅附录A“VMX能力报告机制”）。	

## 24.7 开启并执行VMX操作

在系统软件进入VMX操作之前，需通过设置CR4.VMXE[bit 13] = 1来启用VMX。然后执行VMXON指令以进入VMX操作。如果在CR4.VMXE = 0的情况下执行VMXON，将引发无效操作码异常（#UD）。一旦进入VMX操作，将无法清除CR4.VMXE（参见第24.8节）。系统软件通过执行VMXOFF指令离开VMX操作。在执行VMXOFF后，可以在VMX操作之外清除CR4.VMXE。

IA32_FEATURE_CONTROL MSR（MSR地址为3AH）也可以控制VMXON。当逻辑处理器被复位时，该MSR将被清零。该MSR的相关位是：

- 第0位是锁定位（lock bit）。如果该位清零，执行VMXON将引发通用保护异常。如果设置了锁定位，对该MSR进行WRMSR操作也会引发通用保护异常；直到发生上电复位条件之前，无法修改该MSR。系统BIOS可以使用此位来提供一个选项，以禁用对VMX的支持。要在平台上启用VMX支持，BIOS必须设置第1位、第2位或两者（见下文），以及锁定位。
- 第1位在SMX操作中启用VMXON。如果该位清零，在SMX操作中执行VMXON将引发通用保护异常。试图在不支持VMX操作（参见第24.6节）和SMX操作（参见英特尔® 64和IA-32体系结构软件开发手册第2D卷的第7章“Safer Mode Extensions Reference”）的逻辑处理器上设置此位将引发通用保护异常。
- 第2位使得在SMX操作之外启用VMXON。如果该位清零，在SMX操作之外执行VMXON将引发通用保护异常。试图在不支持VMX操作（参见第24.6节）的逻辑处理器上设置此位将引发通用保护异常。

在执行VMXON之前，软件应分配一个自然对齐的4KB内存区域，逻辑处理器可以使用该区域来支持VMX操作。该区域被称为VMXON区域。VMXON指令的操作数中提供了VMXON区域的地址（即VMXON指针）。第25.11.5节“VMXON区域”详细说明了软件应如何初始化和访问VMXON区域。

## 注意

如果自上次执行GETSEC[SENTER]指令以来，逻辑处理器没有执行过GETSEC[SEXIT]指令，则逻辑处理器处于SMX操作状态。如果在上次执行GETSEC[SENTER]指令之后没有执行GETSEC[SEXIT]指令，或者已经执行了GETSEC[SEXIT]指令，则逻辑处理器处于SMX操作之外的状态。请参考英特尔® 64和IA-32体系结构软件开发手册第2D卷的第7章“Safer Mode Extensions Reference”获取更多信息。

## 24.8 VMX的操作限制

VMX操作对处理器的操作有一些限制，具体如下：

- 在VMX操作中，处理器可以将CR0和CR4寄存器中的某些位固定为特定的值，并不支持其他值。如果这些位中包含不支持的值，VMXON指令将失败（请参见第31章“VMXON—进入VMX操作”）。在VMX操作（包括VMX根操作）中，任何试图将其中一个这些位设置为不支持的值的尝试，使用CLTS、LMSW或MOV CR指令都会引发通用保护异常。VM进入或VM退出不能将这些位设置为不支持的值。软件应查阅VMX功能MSR IA32_VMX_CR0_FIXED0和IA32_VMX_CR0_FIXED1来确定CR0寄存器中哪些位被固定（请参见附录A.7）。对于CR4寄存器，软件应查阅VMX功能MSR IA32_VMX_CR4_FIXED0和IA32_VMX_CR4_FIXED1（请参见附录A.8）。	
- 如果逻辑处理器处于A20M模式，执行VMXON指令将失败（请参见第31章“VMXON—进入VMX操作”）。一旦处理器进入VMX操作，A20M中断将被屏蔽。因此，在VMX操作中无法处于A20M模式。
- 当逻辑处理器处于VMX根操作时，INIT信号被阻塞。在VMX非根操作中，INIT信号不会被阻塞，而是会导致VM退出（请参见第26.2节“VM退出的其他原因”）
- 仅当IA32_VMX_MISC寄存器的第14位为1时，才可以在VMX操作中使用Intel® Processor Trace (Intel PT)（请参见附录A.6）。对于支持Intel PT但不允许在VMX操作中使用的处理器，在执行VMXON指令时会清除IA32_RTIT_CTL.TraceEn位（请参见第31章“VMXON—进入VMX操作”）。在VMX操作中（包括VMX根操作）任何尝试写入IA32_RTIT_CTL都会引发通用保护异常。



